<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Die With Zero è²¡å‹™è¨ˆç®—æ©Ÿ Pro (v4.6 æ·¨é¡é¡¯ç¤ºç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e67e22; /* äº«æ¨‚æ©˜ */
            --growth: #27ae60; /* ç´¯ç©ç¶  */
            --house: #8e44ad;   /* è²·æˆ¿ç´« */
            --flat: #7f8c8d;    /* å¹³æ»‘ç° */
            --bg: #f4f6f8;
            --card-bg: #ffffff;
            --text-light: #636e72;
            --hint-color: #95a5a6;
            --error: #c0392b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--primary);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }

        h1 { text-align: center; margin-bottom: 5px; color: var(--primary); letter-spacing: -0.5px; }
        .subtitle { text-align: center; color: var(--text-light); font-size: 0.95em; margin-bottom: 30px; }

        /* Tabs */
        .tabs { display: flex; margin-bottom: 30px; background: #dfe6e9; border-radius: 12px; padding: 5px; }
        .tab-btn {
            flex: 1; padding: 14px; text-align: center; cursor: pointer; font-weight: bold;
            border-radius: 10px; color: var(--text-light); transition: 0.2s; font-size: 1.05em;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.5); }
        .tab-btn.active.mode-retire { background: #fff; color: var(--accent); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .tab-btn.active.mode-young { background: #fff; color: var(--growth); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Form Layout */
        .section-title {
            font-size: 1.2em; font-weight: 700; margin: 30px 0 20px 0; padding-left: 12px;
            border-left: 5px solid #ddd; color: var(--primary); display: flex; align-items: center; justify-content: space-between;
        }
        .mode-retire .section-title { border-color: var(--accent); }
        .mode-young .section-title { border-color: var(--growth); }
        .section-title.house-title { border-color: var(--house); color: var(--house); cursor: pointer; user-select: none; }
        .section-title.house-title:hover { background-color: #fcf6ff; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .input-group { margin-bottom: 20px; }
        
        label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 0.95em; color: #2d3436; }
        input[type="number"], select {
            width: 100%; padding: 14px; border: 2px solid #e1e4e8; border-radius: 10px;
            font-size: 1.05em; transition: 0.2s; box-sizing: border-box; background: #fff; color: #2d3436;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(44,62,80,0.05); }

        .hint {
            font-size: 0.85em; color: var(--hint-color); margin-top: 6px; line-height: 1.4;
            padding-left: 2px;
        }
        .hint strong { color: #636e72; font-weight: 600; }

        /* Portfolio Customizer Styles */
        .portfolio-toggle {
            display: flex; gap: 10px; margin-bottom: 10px;
        }
        .pt-btn {
            padding: 8px 16px; border-radius: 20px; border: 1px solid #ccc; cursor: pointer; font-size: 0.9em;
            background: #fff; color: #666; user-select: none;
        }
        .pt-btn.active {
            background: var(--primary); color: #fff; border-color: var(--primary);
        }
        
        .portfolio-table {
            width: 100%; border-collapse: separate; border-spacing: 0 8px; margin-top: 10px;
        }
        .portfolio-table th { text-align: left; font-size: 0.8em; color: #666; padding: 0 5px; }
        .portfolio-table td { padding: 0 5px; vertical-align: middle; }
        .portfolio-table select { font-size: 0.9em; padding: 10px; }
        .portfolio-table input { font-size: 0.9em; padding: 10px; }
        .sum-warning {
            color: var(--error); font-weight: bold; font-size: 0.9em; margin-top: 5px; display: none;
            background: #fadbd8; padding: 8px; border-radius: 6px; text-align: center;
        }

        /* Tags / Presets */
        .presets-label { font-size: 0.8em; color: var(--hint-color); margin-bottom: 6px; margin-top: 5px; display: block;}
        .presets { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 5px; }
        .tag {
            background: #f1f3f5; padding: 6px 12px; border-radius: 8px; font-size: 0.85em;
            color: #636e72; cursor: pointer; border: 1px solid #dfe6e9; transition: 0.2s; user-select: none;
        }
        .tag:hover { background: #e2e6ea; border-color: #ced4da; transform: translateY(-1px); }
        .tag.selected { background: #dbe4ff; color: #3b5bdb; border-color: #bac8ff; font-weight: bold; }
        .tag.action-btn { background: #fff8e1; color: #b7791f; border-color: #ffeeba; }
        .tag.risk-high { color: #c0392b; background: #fcebe6; border-color: #fadbd8; }

        /* House Section */
        #house-section, #r-loan-section {
            background: #fdfbff; border: 2px dashed #d7bde2; padding: 20px; border-radius: 12px; display: none; margin-bottom: 20px;
        }
        #house-toggle-text::after, #r-loan-toggle-text::after { content: ' â–¼'; font-size: 0.8em; }
        #house-section.show, #r-loan-section.show { display: block; animation: fadeIn 0.3s; }

        /* Buttons */
        .btn-calc {
            width: 100%; padding: 18px; border: none; border-radius: 12px;
            font-size: 1.2em; font-weight: 800; color: white; cursor: pointer;
            margin-top: 30px; transition: 0.2s; letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn-calc:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .btn-retire { background: linear-gradient(135deg, #e67e22, #d35400); }
        .btn-young { background: linear-gradient(135deg, #27ae60, #219150); }

        /* Result Area */
        .result-box {
            margin-top: 50px; padding: 30px; border-radius: 16px; background: #fff;
            border: 2px solid #f1f3f5; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.05);
        }
        
        .result-header { text-align: center; margin-bottom: 30px; }
        .purchasing-power-badge {
            display: inline-block; background: #e3f2fd; color: #1565c0; padding: 6px 15px;
            border-radius: 30px; font-size: 0.9em; font-weight: bold; margin-bottom: 15px;
            border: 1px solid #bbdefb;
        }

        .phase-container { display: flex; gap: 20px; margin-bottom: 30px; }
        .phase-card {
            flex: 1; padding: 25px 20px; border-radius: 15px; text-align: center; color: white;
            position: relative; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .phase-card:hover { transform: translateY(-5px); }
        .phase-card::before {
            content: ''; position: absolute; top:0; left:0; right:0; height: 6px; background: rgba(0,0,0,0.15);
        }
        .p-gold { background: linear-gradient(135deg, #f1c40f, #f39c12); }
        .p-silver { background: linear-gradient(135deg, #bdc3c7, #7f8c8d); }
        .p-bronze { background: linear-gradient(135deg, #90e0ef, #0077b6); }

        .p-title { font-size: 0.95em; opacity: 0.95; margin-bottom: 8px; font-weight: bold; letter-spacing: 0.5px; }
        .p-amt { font-size: 1.8em; font-weight: 800; margin: 5px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .p-desc { font-size: 0.85em; opacity: 0.9; margin-top: 5px; }

        /* Comparison Box */
        .comparison-box {
            background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;
            border: 1px solid #e9ecef; display: flex; align-items: center; justify-content: space-between;
        }
        .comp-label { font-size: 0.9em; color: #7f8c8d; font-weight: bold; }
        .comp-val { font-size: 1.4em; font-weight: 800; color: var(--flat); }
        .comp-note { font-size: 0.8em; color: #95a5a6; }
        .vs-badge { background: #eee; padding: 5px 10px; border-radius: 50%; font-weight: bold; color: #7f8c8d; font-size: 0.8em;}

        /* Section Separator Title */
        .dwz-section-title {
            text-align: center; font-weight: 800; color: var(--accent); margin: 35px 0 15px 0;
            display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1.1em;
        }
        .dwz-section-title::before, .dwz-section-title::after {
            content: ''; height: 1px; width: 30px; background: #ffe0b2;
        }

        .chart-header {
            font-size: 0.9em; font-weight: bold; color: #2c3e50; margin: 20px 0 10px 0; 
            padding-left: 10px; border-left: 4px solid #ddd;
        }

        .chart-wrap { position: relative; height: 350px; width: 100%; margin-bottom: 30px;}

        /* Footer Note */
        .footer-note {
            margin-top: 60px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            font-size: 0.85em;
            color: #636e72;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        .footer-note h4 { margin-top: 0; color: #2c3e50; }
        .footer-note ol { padding-left: 20px; }
        .footer-note li { margin-bottom: 10px; }

        @media (max-width: 700px) {
            .grid-2, .phase-container, .comparison-box { grid-template-columns: 1fr; flex-direction: column; gap: 15px; }
            .container { padding: 20px; }
            .p-amt { font-size: 1.5em; }
            .comparison-box { text-align: center; }
            .portfolio-table th:nth-child(1), .portfolio-table td:nth-child(1) { width: 40%; }
            .portfolio-table th:nth-child(2), .portfolio-table td:nth-child(2) { width: 30%; }
            .portfolio-table th:nth-child(3), .portfolio-table td:nth-child(3) { width: 30%; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Die With Zero è²¡å‹™è¨ˆç®—æ©Ÿ <span style="font-size:0.5em; vertical-align:top; background:#f1f3f5; padding:3px 6px; border-radius:4px; color:#666; border:1px solid #ddd;">PRO v4.6 æ·¨é¡é¡¯ç¤ºç‰ˆ</span></h1>
    <p class="subtitle">å…¨è‡ªå‹•ä¿å®ˆç®—æ³•ãƒ»å…¨éšæ®µè‡ªè¨‚é…ç½®ãƒ»äººç”Ÿé«”é©—ç©åˆ†</p>

    <div style="text-align:center; margin-bottom:10px; font-size:0.85em; color:#95a5a6;">ğŸ‘‡ è«‹å…ˆé¸æ“‡æ‚¨çš„èº«åˆ†æ¨¡å¼</div>
    <div class="tabs">
        <div class="tab-btn active mode-retire" onclick="switchMode('retire')">ğŸ‘´ æˆ‘å·²é€€ä¼‘<div style="font-size:0.75em; font-weight:normal; margin-top:3px;">(æé ˜æ¨¡å¼)</div></div>
        <div class="tab-btn mode-young" onclick="switchMode('young')">ğŸ§‘ é‚„åœ¨åŠªåŠ›<div style="font-size:0.75em; font-weight:normal; margin-top:3px;">(è³‡ç”¢ç´¯ç©+è²·æˆ¿æ¨¡æ“¬)</div></div>
    </div>

    <div class="input-group">
        <label>ğŸ’¸ æœªä¾†å¹³å‡é€šè†¨ç‡ (Inflation Rate)</label>
        <div class="grid-2" style="grid-template-columns: 1fr 2fr; gap:15px;">
            <input type="number" id="inflation" value="2.5" step="0.1">
            <div>
                <span class="presets-label">ğŸ‘‡ é»æ“Šå¿«é€Ÿå¸¶å…¥åƒè€ƒå€¼ï¼š</span>
                <div class="presets">
                    <div class="tag" onclick="setVal('inflation', 1.5)">1.5% (å®˜æ–¹æ•¸æ“š)</div>
                    <div class="tag selected" onclick="setVal('inflation', 2.5)">2.5% (æŠ˜è¡·å»ºè­°)</div>
                    <div class="tag" onclick="setVal('inflation', 3.0)">3.0% (é«”æ„Ÿé€šè†¨)</div>
                </div>
            </div>
        </div>
        <div class="hint">
            <strong>å½±éŸ¿è³¼è²·åŠ›ï¼š</strong>æ­¤æ•¸å€¼æ±ºå®šæœªä¾†ã€ŒéŒ¢è®Šè–„ã€çš„é€Ÿåº¦ã€‚è‹¥è¨­ç‚º 2.5%ï¼Œä»£è¡¨ 30 å¹´å¾Œçš„ 100 å…ƒåªå‰©ç¾åœ¨ç´„ 47 å…ƒçš„åƒ¹å€¼ã€‚
        </div>
    </div>

    <div id="tab-retire" class="tab-content active mode-retire">
        <div class="section-title">Step 1: ç›¤é»æ‚¨çš„ç¾æ³</div>
        <div class="grid-2">
            <div class="input-group">
                <label>ğŸ’° ç¾æœ‰å¯æŠ•è³‡è³‡ç”¢ (è¬)</label>
                <input type="number" id="r-assets" value="1000" placeholder="ä¾‹: 1000">
                <div class="hint">è«‹è¼¸å…¥è‚¡ç¥¨ã€åŸºé‡‘ã€å®šå­˜ã€ç¾é‡‘ç¸½å’Œã€‚<br>âš ï¸ <strong>ä¸åŒ…å«</strong>è‡ªä½ä¸”ä¸æ‰“ç®—è³£å‡ºçš„æˆ¿ç”¢ã€‚</div>
            </div>
            <div class="input-group">
                <label>ğŸ›¡ï¸ ç·Šæ€¥é å‚™é‡‘(è¬)</label>
                <input type="number" id="r-buffer" value="300" placeholder="ä¾‹: 300">
                <div class="hint">é€™ç­†éŒ¢æ˜¯æ‚¨çš„<strong>å®‰å…¨æ°£å›Š</strong>ï¼Œè¨ˆç®—æ™‚æœƒå…ˆè¢«æ‰£é™¤ã€‚</div>
            </div>
        </div>

        <div class="section-title house-title" onclick="toggleRetireLoan()">
            <span id="r-loan-toggle-text">ğŸ  æˆ¿å±‹å¢è²¸æ´»åŒ–è³‡ç”¢ (é»æ“Šå±•é–‹)</span>
            <input type="checkbox" id="r-loan-enabled" style="display:none">
        </div>
        <div id="r-loan-section">
            <div class="grid-2">
                <div class="input-group">
                    <label>ğŸ’¸ å¢è²¸é‡‘é¡ (è¬)</label>
                    <input type="number" id="r-loan-amt" value="500">
                </div>
                <div class="input-group">
                    <label>ğŸ“‰ è²¸æ¬¾åˆ©ç‡ (%)</label>
                    <input type="number" id="r-loan-rate" value="2.2" step="0.1">
                </div>
            </div>
            <div class="input-group">
                <label>ğŸ“… é‚„æ¬¾å¹´é™ (å¹´)</label>
                <input type="number" id="r-loan-years" value="20">
            </div>
            <div class="hint">
                èªªæ˜ï¼šæ­¤ç­†è³‡é‡‘å°‡è‡ªå‹•ä½µå…¥ã€Œç¾æœ‰å¯æŠ•è³‡è³‡ç”¢ã€é€²è¡ŒæŠ•è³‡æ»¾åˆ©ã€‚è¨ˆç®—çµæœå°‡è‡ªå‹•æ‰£é™¤æ¯æœˆæ‡‰ç¹³æœ¬æ¯ã€‚
            </div>
        </div>

        <div class="section-title">Step 2: è¨­å®šæ™‚é–“èˆ‡å ±é…¬</div>
        <div class="grid-2">
            <div class="input-group">
                <label>ğŸ‘¤ ç›®å‰å¹´é½¡ (æ­²)</label>
                <input type="number" id="r-age-now" value="55">
            </div>
            <div class="input-group">
                <label>ğŸ äººç”Ÿç™»å‡ºå¹´é½¡ (æ­²)</label>
                <input type="number" id="r-age-end" value="85">
            </div>
        </div>

        <div class="input-group">
            <label>ğŸ“ˆ æŠ•è³‡çµ„åˆé æœŸå ±é…¬ç‡ (åç›®, %)</label>
            
            <div class="portfolio-toggle">
                <div class="pt-btn active" id="r-btn-simple" onclick="togglePortfolioMode('r', 'simple')">ä¸€èˆ¬è¨­å®š</div>
                <div class="pt-btn" id="r-btn-custom" onclick="togglePortfolioMode('r', 'custom')">è‡ªè¨‚æŠ•è³‡çµ„åˆ</div>
                <input type="hidden" id="r-mode-val" value="simple">
            </div>

            <div id="r-simple-block">
                <input type="number" id="r-rate" value="4.5" step="0.1">
                <span class="presets-label">ğŸ‘‡ å¿«é€Ÿå¸¶å…¥ï¼š</span>
                <div class="presets">
                    <div class="tag" onclick="setVal('r-rate', 5.5)">ç©©å¥é ˜æ¯ (0056)</div>
                    <div class="tag selected" onclick="setVal('r-rate', 4.5)">å¹³è¡¡å‹ (0050/ç¾)</div>
                    <div class="tag" onclick="setVal('r-rate', 6.5)">ç¾è‚¡å¹³è¡¡ (VOO/å‚µ)</div>
                    <div class="tag" onclick="setVal('r-rate', 8.0)">ç©æ¥µ (0050)</div>
                    <div class="tag" onclick="setVal('r-rate', 8.0)">æ§“æ¡¿å¹³è¡¡ (631L/ç¾)</div>
                    <div class="tag risk-high" onclick="setVal('r-rate', 15.0)">å…¨æ§“æ¡¿ (00631L)</div>
                </div>
            </div>

            <div id="r-custom-block" style="display:none;">
                <table class="portfolio-table" id="r-portfolio-table">
                    <thead><tr><th>æ¨™çš„ (è‡ªå‹•å¸¶å…¥åƒè€ƒå ±é…¬)</th><th>é æœŸå ±é…¬(%)</th><th>æ¯”ä¾‹(%)</th></tr></thead>
                    <tbody></tbody> </table>
                <div class="sum-warning" id="r-sum-warning">âš ï¸ è­¦å‘Šï¼šç›®å‰é…ç½®æ¯”ä¾‹ç¸½å’Œç‚º 0%ï¼Œå¿…é ˆç­‰æ–¼ 100% æ‰èƒ½è¨ˆç®—ã€‚</div>
            </div>

            <div class="hint">
                <span style="color:#27ae60; font-weight:bold;">â˜… ç³»çµ±æ¡ã€Œä¿å®ˆæ¼”ç®—æ³•ã€ï¼šå¿½ç•¥æœˆè¤‡åˆ©ï¼Œå‡è¨­è³‡é‡‘æ¯å¹´åªæ»¾å‹•ä¸€æ¬¡ã€‚</span>
            </div>
        </div>

        <button class="btn-calc btn-retire" onclick="calcRetire()">ğŸš€ è¨ˆç®—æˆ‘çš„ã€Œäº«æ¨‚é ç®—ã€</button>
    </div>

    <div id="tab-young" class="tab-content mode-young">
        <div class="section-title">Step 1: ç´¯ç©æœŸ (ç¾åœ¨ â†’ é€€ä¼‘)</div>
        <div class="grid-2">
            <div class="input-group">
                <label>ğŸ‘¤ ç›®å‰å¹´é½¡</label>
                <input type="number" id="y-age-now" value="30">
            </div>
            <div class="input-group">
                <label>ğŸ–ï¸ é è¨ˆé€€ä¼‘å¹´é½¡</label>
                <input type="number" id="y-age-retire" value="55">
            </div>
        </div>

        <div class="grid-2">
            <div class="input-group">
                <label>ğŸ¦ ç›®å‰å·²æœ‰è³‡ç”¢ (è¬)</label>
                <input type="number" id="y-current" value="100">
            </div>
            <div class="input-group">
                <label>ğŸ’µ æ¯æœˆå®šæœŸå®šé¡æŠ•å…¥ (å…ƒ)</label>
                <input type="number" id="y-monthly" value="20000">
            </div>
        </div>
        
        <div class="input-group">
            <label>ğŸš€ ç´¯ç©æœŸé æœŸå ±é…¬ç‡ (%)</label>
            
             <div class="portfolio-toggle">
                <div class="pt-btn active" id="y-btn-simple" onclick="togglePortfolioMode('y', 'simple')">ä¸€èˆ¬è¨­å®š</div>
                <div class="pt-btn" id="y-btn-custom" onclick="togglePortfolioMode('y', 'custom')">è‡ªè¨‚æŠ•è³‡çµ„åˆ</div>
                <input type="hidden" id="y-mode-val" value="simple">
            </div>

            <div id="y-simple-block">
                <div class="grid-2" style="grid-template-columns: 1fr 3fr; gap:15px;">
                    <input type="number" id="y-rate-acc" value="8.0" step="0.1">
                    <div>
                        <span class="presets-label">ğŸ‘‡ åƒè€ƒï¼š</span>
                        <div class="presets">
                            <div class="tag" onclick="setVal('y-rate-acc', 8)">0050 (~8%)</div>
                            <div class="tag" onclick="setVal('y-rate-acc', 9)">VOO (~9%)</div>
                            <div class="tag" onclick="setVal('y-rate-acc', 11)">QQQ (~11%)</div>
                            <div class="tag risk-high" onclick="setVal('y-rate-acc', 15)">00631L (~15%)</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="y-custom-block" style="display:none;">
                <table class="portfolio-table" id="y-portfolio-table">
                    <thead><tr><th>æ¨™çš„ (è‡ªå‹•å¸¶å…¥åƒè€ƒå ±é…¬)</th><th>é æœŸå ±é…¬(%)</th><th>æ¯”ä¾‹(%)</th></tr></thead>
                    <tbody></tbody>
                </table>
                <div class="sum-warning" id="y-sum-warning">âš ï¸ è­¦å‘Šï¼šç›®å‰é…ç½®æ¯”ä¾‹ç¸½å’Œç‚º 0%ï¼Œå¿…é ˆç­‰æ–¼ 100% æ‰èƒ½è¨ˆç®—ã€‚</div>
            </div>
            <div class="hint">
                <span style="color:#27ae60; font-weight:bold;">â˜… ä¿å®ˆæ¼”ç®—æ³•ï¼šå®šæœŸå®šé¡è¦–ç‚ºå¹´åº•ä¸€æ¬¡æŠ•å…¥ï¼Œå¿½ç•¥æœˆè¤‡åˆ©ã€‚</span>
            </div>
        </div>

        <div class="input-group">
            <label>ğŸ‘´ é ä¼°é€€ä¼‘é‡‘ä¸€æ¬¡é ˜ç¸½é¡ (è¬)</label>
            <input type="number" id="y-pension" value="200" placeholder="é¸å¡«ï¼Œä¾‹å¦‚ 200">
        </div>

        <div class="section-title house-title" onclick="toggleHouse()">
            <span id="house-toggle-text">ğŸ  è²·æˆ¿è¨ˆç•« (é»æ“Šå±•é–‹è©¦ç®—)</span>
            <input type="checkbox" id="house-enabled" style="display:none">
        </div>
        <div id="house-section">
            <div class="grid-2">
                <div class="input-group">
                    <label>ğŸ“… é è¨ˆè²·æˆ¿å¹´é½¡ (æ­²)</label>
                    <input type="number" id="h-age" value="35">
                </div>
                <div class="input-group">
                    <label>ğŸ·ï¸ æˆ¿å±‹ç¸½åƒ¹ (è¬)</label>
                    <input type="number" id="h-price" value="1500">
                </div>
            </div>
            <div class="grid-2">
                <div class="input-group">
                    <label>ğŸ’° é ­æœŸæ¬¾æ¯”ä¾‹ (%)</label>
                    <input type="number" id="h-down-pct" value="20">
                </div>
                <div class="input-group">
                    <label>ğŸ’¸ æˆ¿è²¸åˆ©ç‡ (%) / å¹´é™ (å¹´)</label>
                    <div style="display:flex; gap:10px">
                        <input type="number" id="h-rate" value="2.2" step="0.1" placeholder="åˆ©ç‡">
                        <input type="number" id="h-years" value="30" placeholder="å¹´é™">
                    </div>
                </div>
            </div>
            <div class="input-group">
                <label>ğŸ  åŸæœ¬çš„æˆ¿ç§Ÿé ç®— (å…ƒ/æœˆ)</label>
                <input type="number" id="h-rent" value="15000">
            </div>
        </div>

        <div class="section-title">Step 2: æé ˜æœŸ (é€€ä¼‘ â†’ ç™»å‡º)</div>
        <div class="grid-2">
             <div class="input-group">
                <label>ğŸ äººç”Ÿç™»å‡ºå¹´é½¡</label>
                <input type="number" id="y-age-end" value="85">
            </div>
            <div class="input-group">
                <label>ğŸ›¡ï¸ é€€ä¼‘å¾Œä¿ç•™é å‚™é‡‘ (%)</label>
                <input type="number" id="y-buffer-pct" value="20">
            </div>
        </div>

        <div class="input-group">
            <label>ğŸ¢ é€€ä¼‘å¾ŒæŠ•è³‡å ±é…¬ç‡ (%)</label>
            
            <div class="portfolio-toggle">
                <div class="pt-btn active" id="y-dec-btn-simple" onclick="togglePortfolioMode('y-dec', 'simple')">ä¸€èˆ¬è¨­å®š</div>
                <div class="pt-btn" id="y-dec-btn-custom" onclick="togglePortfolioMode('y-dec', 'custom')">è‡ªè¨‚æŠ•è³‡çµ„åˆ</div>
                <input type="hidden" id="y-dec-mode-val" value="simple">
            </div>

             <div id="y-dec-simple-block">
                <div class="grid-2" style="grid-template-columns: 1fr 3fr; gap:15px;">
                    <input type="number" id="y-rate-dec" value="4.5" step="0.1">
                    <div>
                        <span class="presets-label">ğŸ‘‡ é€€ä¼‘æŠ•è³‡é¢¨æ ¼ï¼š</span>
                        <div class="presets">
                            <div class="tag action-btn" onclick="copyRateToDec()">ğŸ”„ ç¶­æŒä¸è®Š</div>
                            <div class="tag" onclick="setVal('y-rate-dec', 5.5)">ç©©å¥é ˜æ¯ (0056)</div>
                            <div class="tag" onclick="setVal('y-rate-dec', 4.5)">å¹³è¡¡å‹ (0050/ç¾)</div>
                            <div class="tag" onclick="setVal('y-rate-dec', 6.5)">ç¾è‚¡å¹³è¡¡ (VOO/å‚µ)</div>
                            <div class="tag" onclick="setVal('y-rate-dec', 8.0)">ç©æ¥µ (0050)</div>
                            <div class="tag" onclick="setVal('y-rate-dec', 8.0)">æ§“æ¡¿å¹³è¡¡ (631L/ç¾)</div>
                            <div class="tag risk-high" onclick="setVal('y-rate-dec', 15.0)">å…¨æ§“æ¡¿ (00631L)</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="y-dec-custom-block" style="display:none;">
                <table class="portfolio-table" id="y-dec-portfolio-table">
                    <thead><tr><th>æ¨™çš„ (è‡ªå‹•å¸¶å…¥åƒè€ƒå ±é…¬)</th><th>é æœŸå ±é…¬(%)</th><th>æ¯”ä¾‹(%)</th></tr></thead>
                    <tbody></tbody>
                </table>
                <div class="sum-warning" id="y-dec-sum-warning">âš ï¸ è­¦å‘Šï¼šç›®å‰é…ç½®æ¯”ä¾‹ç¸½å’Œç‚º 0%ï¼Œå¿…é ˆç­‰æ–¼ 100% æ‰èƒ½è¨ˆç®—ã€‚</div>
            </div>

            <div class="hint">
                <span style="color:#27ae60; font-weight:bold;">â˜… ä¿å®ˆæ¼”ç®—æ³•ï¼šå¿½ç•¥æœˆè¤‡åˆ©ï¼Œæ¯å¹´åªæ»¾å‹•ä¸€æ¬¡ã€‚</span>
            </div>
        </div>

        <button class="btn-calc btn-young" onclick="calcYoung()">ğŸ”® é æ¸¬æœªä¾†è³‡ç”¢ & ç”Ÿæ´»å“è³ª</button>
    </div>

    <div id="result-area" class="result-box">
        <div class="result-header">
            <div class="purchasing-power-badge">âœ¨ é‡‘é¡çš†å·²æ›ç®—ç‚ºã€Œä»Šæ—¥è³¼è²·åŠ›ã€</div>
            <div id="result-summary"></div>
            <div id="house-impact-msg" style="margin-top:15px; padding:10px; background:#fce4ec; border-radius:8px; color:#c2185b; display:none; font-size:0.9em; line-height:1.5;"></div>
            <div class="hint" style="margin-top:10px;">(é€™ä»£è¡¨ï¼šé›–ç„¶å¸³é¢ä¸Šé‡‘é¡å¾ˆå¤§ï¼Œä½†å¯¦éš›èƒ½è²·åˆ°çš„æ±è¥¿ï¼Œç›¸ç•¶æ–¼ç¾åœ¨é€™å€‹é‡‘é¡çš„åƒ¹å€¼)</div>
        </div>
        
        <div id="comparison-block" class="comparison-box" style="display:none;">
            <div>
                <div class="comp-label">å‚³çµ±å¹³æ»‘æé ˜æ³• (å›ºå®šèŠ±è²»)</div>
                <div class="comp-note" id="comp-note-text">æ¯æœˆå¯èŠ± (å¯¦è³ªè³¼è²·åŠ›)</div>
            </div>
            <div class="vs-badge">VS</div>
            <div style="text-align:right;">
                <div class="comp-val" id="flat-val">$0</div>
                <div class="comp-note">æ¯æœˆå¯èŠ± (å¯¦è³ªè³¼è²·åŠ›)</div>
            </div>
        </div>

        <div id="dwz-section-title" class="dwz-section-title" style="display:none;">
            ğŸ‘‡ Die With Zero å»ºè­°æé ˜æ³• (3-2-1 éšæ¢¯å¼)
        </div>

        <div class="phase-container" id="phase-container"></div>

        <div id="acc-chart-container" style="display:none;">
            <div class="chart-header">ğŸ“ˆ ç¬¬ä¸€éšæ®µï¼šè³‡ç”¢ç´¯ç©é æ¸¬ (è‡³é€€ä¼‘)</div>
            <div class="chart-wrap">
                <canvas id="chartAcc"></canvas>
            </div>
        </div>

        <div class="chart-header">ğŸ“‰ ç¬¬äºŒéšæ®µï¼šé€€ä¼‘å¾Œæé ˜èˆ‡æ¶ˆè²» (Die With Zero vs å‚³çµ±)</div>
        <div class="chart-wrap">
            <canvas id="chartDec"></canvas>
        </div>

        <div class="hint" style="text-align:center; margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <strong>åœ–è¡¨èªªæ˜ï¼š</strong><br>
            <span style="color:#e67e22">â–  å½©è‰²æŸ±ç‹€åœ–</span>ï¼šDie With Zero å»ºè­°èŠ±è²» (å¹´è¼•å¤šèŠ±)ã€‚<br>
            <span style="color:#7f8c8d; text-decoration: underline dashed;">-- ç°è‰²è™›ç·š</span>ï¼šå‚³çµ±å¹³æ»‘åˆ†é… (æ¯å¹´èŠ±ä¸€æ¨£å¤š)ã€‚
        </div>
    </div>

    <div class="footer-note">
        <h4>â„¹ï¸ æŠ•è³‡çµ„åˆé æœŸå ±é…¬ç‡æ¼”ç®—æ³•èªªæ˜</h4>
        
        <p>æœ¬é æ¡æœ€ä¿å®ˆçš„å¹´è¤‡åˆ©ç®—æ³•ï¼š<span style="color:#e67e22; font-weight:bold;">ã€Œå¿½ç•¥æœˆè¤‡åˆ©ï¼Œæ¯å¹´åªæ»¾å‹•ä¸€æ¬¡ã€</span>ã€‚</p>
        
        <p><strong>é€™å°è¨ˆç®—æ©Ÿæ˜¯æ€éº¼ç®—çš„ï¼Ÿç‚ºä»€éº¼èªªå®ƒã€Œæœ€ä¿å®ˆã€ï¼Ÿ</strong><br>
        ç‚ºäº†ä¸è®“æ‚¨å°æœªä¾†å¤ªéæ¨‚è§€ï¼Œæˆ‘å€‘åœ¨æ¼”ç®—æ³•ä¸Šç‰¹åˆ¥åŠ äº†<strong>å…©é“ã€Œå®‰å…¨é–ã€</strong>ï¼š</p>

        <div style="margin-bottom:20px; padding-left:15px; border-left:4px solid #27ae60; background:#f9fbf9; padding:10px;">
            <strong>ğŸ”’ ç¬¬ä¸€é“å®‰å…¨é– (å­˜éŒ¢æ™‚)ï¼šå¿½ç•¥æœˆè¤‡åˆ©</strong>
            <p style="margin:5px 0; font-size:0.95em;">åœ¨è¨­å®šå¹´åŒ–å ±é…¬ç‡ (ä¾‹å¦‚ 15%) é€²è¡Œå®šæœŸå®šé¡è©¦ç®—æ™‚ï¼Œã€Œæœˆåˆ©ç‡ã€çš„å®šç¾©æ±ºå®šäº†æœ€çµ‚è³‡ç”¢çš„å·®ç•°ã€‚ä»¥ä¸‹æ˜¯ä¸‰ç¨®å¸¸è¦‹é‚è¼¯ï¼š</p>
            <ol style="margin:5px 0 0 0; padding-left:20px; font-size:0.9em; color:#555;">
                <li style="margin-bottom:5px;"><strong>éŠ€è¡Œç®—æ³• (æœ€æ¨‚è§€)ï¼š</strong>å‡è¨­å¹´åˆ©ç‡ç›´æ¥é™¤ä»¥ 12 å°±æ˜¯æœˆåˆ©ç‡ã€‚å¯¦éš›æœ‰æ•ˆå¹´åˆ©ç‡(EAR)æœƒé«˜é” 16.07%ã€‚</li>
                <li style="margin-bottom:5px;"><strong>æŠ•è³‡åš´è¬¹ç®—æ³• (æœ€ç²¾ç¢º)ï¼š</strong>åš´æ ¼å®šç¾©ã€Œä¸€å¹´ä¸‹ä¾†å°±æ˜¯å‰›å¥½ 15%ã€ï¼Œåæ¨è¼ƒä½çš„æœˆåˆ©ç‡ã€‚</li>
                <li style="margin-bottom:5px;"><strong>ç°¡æ˜“ä¼°ç®— (æœ€ä¿å®ˆ) <span style="color:#e67e22;">[æœ¬ç«™æ¡ç”¨]</span>ï¼š</strong>
                    ä¸è¨ˆç®—æ¯æœˆè¤‡åˆ©ï¼Œå‡è¨­éŒ¢æŠ•å…¥å¾Œï¼Œ<strong>è¦ç­‰åˆ°å¹´åº•æ‰ä¸€æ¬¡æ€§çµç®—åˆ©æ¯</strong>ã€‚å› ç‚ºå¿½ç•¥äº†è³‡é‡‘åœ¨ä¸€å¹´ä¹‹ä¸­ç”¢ç”Ÿçš„æ™‚é–“åƒ¹å€¼ï¼Œç®—å‡ºä¾†çš„é‡‘é¡æœ€å°‘ï¼Œé©åˆä½œç‚ºé€€ä¼‘è¨ˆåŠƒçš„å®‰å…¨é‚Šéš›ã€‚
                </li>
            </ol>
        </div>

        <div style="margin-bottom:20px; padding-left:15px; border-left:4px solid #e67e22; background:#fffbf0; padding:10px;">
            <strong>ğŸ”’ ç¬¬äºŒé“å®‰å…¨é– (èŠ±éŒ¢æ™‚)ï¼šè‡ªå‹•æ‰£é™¤é€šè†¨</strong>
            <p style="margin:5px 0 0 0; font-size:0.95em;">
                åœ¨è¨ˆç®—é€€ä¼‘å¾Œã€Œæ¯æœˆå¯èŠ±å¤šå°‘ã€æ™‚ï¼Œç¨‹å¼æœƒå…ˆå°‡å ±é…¬ç‡<strong>æ‰£é™¤é€šè†¨ç‡</strong> (ä¾‹å¦‚ 8% - 2.5% = 5.5%)ã€‚ç¢ºä¿ç®—å‡ºä¾†çš„é‡‘é¡æ˜¯<strong>ã€Œä»Šæ—¥è³¼è²·åŠ›ã€</strong>ï¼Œè®“æ‚¨çŸ¥é“é€€ä¼‘å¾Œå¯¦éš›èƒ½è²·å¤šå°‘æ±è¥¿ï¼Œè€Œä¸æ˜¯çœ‹è‘—å¾ˆå¤§ä½†è²¶å€¼çš„æ•¸å­—è‡ªæˆ‘å®‰æ…°ã€‚
            </p>
        </div>

        <p style="text-align:center; font-weight:bold; color:#2c3e50;">
            ğŸ“ ç¸½çµï¼šã€Œå¯§å¯ç¾åœ¨ä½ä¼°ï¼Œä¹Ÿä¸è¦è€äº†ä¸å¤ ã€‚ã€<br>é€éé›™é‡ä¿å®ˆæ©Ÿåˆ¶ï¼Œåªè¦é€™è£¡ç®—å‡ºä¾†é¡¯ç¤º Safeï¼Œç¾å¯¦ç”Ÿæ´»ä¸­é€€ä¼‘æˆåŠŸçš„æ©Ÿç‡å°±æœƒéå¸¸é«˜ï¼
        </p>
    </div>
</div>

<script>
    // --- Data Definitions ---
    const ASSET_OPTIONS = [
        { id: '0050', name: '0050 (å…ƒå¤§å°ç£50)', rate: 8.0 },
        { id: '0056', name: '0056 (å…ƒå¤§é«˜è‚¡æ¯)', rate: 5.5 },
        { id: '00631L', name: '00631L (50æ­£2)', rate: 15.0 },
        { id: 'VOO', name: 'VOO (æ¨™æ™®500)', rate: 8.0 },
        { id: 'QQQ', name: 'QQQ (é‚£æ–¯é”å…‹)', rate: 10.0 },
        { id: 'QLD', name: 'QLD (é‚£æ–¯é”å…‹2å€)', rate: 12.0 },
        { id: 'TQQQ', name: 'TQQQ (é‚£æ–¯é”å…‹3å€)', rate: 15.0 },
        { id: 'CASH', name: 'ç¾é‡‘ (å³å®šå­˜)', rate: 1.0 },
        { id: 'BOND', name: 'ç¾è‚¡çŸ­å‚µ (SGOV/SHV)', rate: 3.5 }
    ];

    // --- Initialization ---
    window.onload = function() {
        generatePortfolioRows('r-portfolio-table', 'r-port');       // é€€ä¼‘æ¨¡å¼
        generatePortfolioRows('y-portfolio-table', 'y-port');       // å¹´è¼•äºº - ç´¯ç©æœŸ
        generatePortfolioRows('y-dec-portfolio-table', 'y-dec-port'); // å¹´è¼•äºº - æé ˜æœŸ (New)
    };

    // --- UI Helpers ---
    function switchMode(mode) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`.mode-${mode}`).classList.add('active');
        document.getElementById(`tab-${mode}`).classList.add('active');
        document.getElementById('result-area').style.display = 'none';
        
        document.querySelectorAll('.presets .tag').forEach(t => t.classList.remove('selected'));
    }

    function setVal(id, val) {
        document.getElementById(id).value = val;
        const presets = event.target.closest('.presets');
        if (presets) {
            presets.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
            event.target.classList.add('selected');
        }
    }

    function toggleHouse() {
        const section = document.getElementById('house-section');
        const checkbox = document.getElementById('house-enabled');
        const text = document.getElementById('house-toggle-text');
        
        if (section.style.display === 'block') {
            section.style.display = 'none';
            section.classList.remove('show');
            checkbox.checked = false;
            text.innerText = "ğŸ  è²·æˆ¿è¨ˆç•« (é»æ“Šå±•é–‹è©¦ç®—)";
            text.style.color = "#8e44ad";
        } else {
            section.style.display = 'block';
            setTimeout(() => section.classList.add('show'), 10);
            checkbox.checked = true;
            text.innerText = "ğŸ  è²·æˆ¿è¨ˆç•« (å·²å•Ÿç”¨)";
            text.style.color = "#27ae60";
        }
    }

    function toggleRetireLoan() {
        const section = document.getElementById('r-loan-section');
        const checkbox = document.getElementById('r-loan-enabled');
        const text = document.getElementById('r-loan-toggle-text');
        
        if (section.style.display === 'block') {
            section.style.display = 'none';
            section.classList.remove('show');
            checkbox.checked = false;
            text.innerText = "ğŸ  æˆ¿å±‹å¢è²¸æ´»åŒ–è³‡ç”¢ (é»æ“Šå±•é–‹)";
            text.style.color = "#8e44ad";
        } else {
            section.style.display = 'block';
            setTimeout(() => section.classList.add('show'), 10);
            checkbox.checked = true;
            text.innerText = "ğŸ  æˆ¿å±‹å¢è²¸æ´»åŒ–è³‡ç”¢ (å·²å•Ÿç”¨)";
            text.style.color = "#27ae60";
        }
    }

    function copyRateToDec() {
        const accMode = document.getElementById('y-mode-val').value;
        if (accMode === 'custom') {
            alert("âš ï¸ ç„¡æ³•è‡ªå‹•å¸¶å…¥ï¼š\nç´¯ç©æœŸç›®å‰è¨­å®šç‚ºã€Œè‡ªè¨‚æŠ•è³‡çµ„åˆã€ã€‚\nè«‹æ‰‹å‹•è¼¸å…¥æ‚¨é€€ä¼‘å¾Œçš„é æœŸå ±é…¬ç‡ã€‚");
            return;
        }

        const accRate = document.getElementById('y-rate-acc').value;
        document.getElementById('y-rate-dec').value = accRate;
        const presets = event.target.closest('.presets');
        if (presets) {
            presets.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
            event.target.classList.add('selected');
        }
    }

    function formatMoney(num) {
        if (isNaN(num)) return "0";
        return Math.round(num).toLocaleString('zh-TW');
    }

    function getNum(id) {
        const val = document.getElementById(id).value;
        return val === "" ? 0 : parseFloat(val);
    }

    // --- Portfolio Logic ---
    function togglePortfolioMode(prefix, mode) {
        // Switch Buttons
        document.getElementById(`${prefix}-btn-simple`).className = mode === 'simple' ? 'pt-btn active' : 'pt-btn';
        document.getElementById(`${prefix}-btn-custom`).className = mode === 'custom' ? 'pt-btn active' : 'pt-btn';
        
        // Show/Hide Blocks
        document.getElementById(`${prefix}-simple-block`).style.display = mode === 'simple' ? 'block' : 'none';
        document.getElementById(`${prefix}-custom-block`).style.display = mode === 'custom' ? 'block' : 'none';
        
        // Update Hidden Input
        document.getElementById(`${prefix}-mode-val`).value = mode;
    }

    function generatePortfolioRows(tableId, classPrefix) {
        const tbody = document.querySelector(`#${tableId} tbody`);
        let html = '';
        // Create 5 rows
        for(let i=0; i<5; i++) {
            html += `
                <tr>
                    <td>
                        <select class="${classPrefix}-select" onchange="updateRate(this)">
                            <option value="">-- è«‹é¸æ“‡ --</option>
                            ${ASSET_OPTIONS.map(opt => `<option value="${opt.rate}">${opt.name}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <input type="number" class="${classPrefix}-rate" step="0.1" placeholder="è‡ªå‹•å¸¶å…¥">
                    </td>
                    <td>
                        <input type="number" class="${classPrefix}-pct" placeholder="0" oninput="checkSum('${classPrefix}')">
                    </td>
                </tr>
            `;
        }
        tbody.innerHTML = html;
    }

    function updateRate(selectElem) {
        const row = selectElem.closest('tr');
        // Find the FIRST input in the row, which is the rate input
        const rateInput = row.querySelector('input[type="number"]'); 
        if (selectElem.value !== "") {
            rateInput.value = selectElem.value;
        } else {
            rateInput.value = "";
        }
    }

    function checkSum(classPrefix) {
        let total = 0;
        document.querySelectorAll(`.${classPrefix}-pct`).forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        
        // Need to map prefix to warning ID
        let warningId = '';
        if (classPrefix === 'r-port') warningId = 'r-sum-warning';
        else if (classPrefix === 'y-port') warningId = 'y-sum-warning';
        else if (classPrefix === 'y-dec-port') warningId = 'y-dec-sum-warning';
        
        const warningDiv = document.getElementById(warningId);
        
        if (Math.abs(total - 100) > 0.1) {
            warningDiv.style.display = 'block';
            warningDiv.innerText = `âš ï¸ è­¦å‘Šï¼šç›®å‰é…ç½®ç¸½å’Œç‚º ${total}%ï¼Œå¿…é ˆç­‰æ–¼ 100% æ‰èƒ½è¨ˆç®—ã€‚`;
            return false;
        } else {
            warningDiv.style.display = 'none';
            return true;
        }
    }

    function getPortfolioRate(prefix, modeInputId, simpleRateId, classPrefix) {
        const mode = document.getElementById(modeInputId).value;
        if (mode === 'simple') {
            return getNum(simpleRateId);
        } else {
            // Check sum first
            if (!checkSum(classPrefix)) return -1; // Error code

            let weightedRate = 0;
            // Iterate all rows to calculate weighted average
            const selects = document.querySelectorAll(`.${classPrefix}-select`);
            selects.forEach((sel) => {
                const row = sel.closest('tr');
                const r = parseFloat(row.querySelector(`.${classPrefix}-rate`).value) || 0;
                const p = parseFloat(row.querySelector(`.${classPrefix}-pct`).value) || 0;
                weightedRate += r * (p / 100);
            });
            return weightedRate;
        }
    }

    // --- Math Helpers (Conservative) ---
    function PMT_Loan(rate, nper, pv) {
        // æˆ¿è²¸è¨ˆç®—ä»ç¶­æŒæ¨™æº–éŠ€è¡Œç®—æ³• (å› ç‚ºéŠ€è¡ŒçœŸçš„é€™æ¨£ç®—)
        if (rate === 0) return pv / (nper * 12);
        const r = rate / 100 / 12;
        const n = nper * 12;
        return (pv * r) / (1 - Math.pow(1 + r, -n));
    }

    // å¹´é‡‘è¨ˆç®—ï¼šæ”¹ç”¨ Annual Annuity (ä¿å®ˆç®—æ³•ï¼Œä¸€å¹´ä¸€ä»˜)
    function PMT_Annuity_Annual(principal, realRate, years) {
        const r = realRate / 100;
        if (r === 0) return principal / years;
        // P * r / (1 - (1+r)^-n)
        return (principal * r) / (1 - Math.pow(1 + r, -years));
    }

    function calculateBaseUnit_Annual(principal, realRate, totalYears) {
        // Die With Zero 3 Buckets Logic adapted for Annual compounding
        const r = realRate / 100;
        const bucketSize = totalYears / 3; 
        let denominator = 0;

        for (let t = 1; t <= totalYears; t++) {
            let weight = 1;
            if (t <= bucketSize) weight = 3;
            else if (t <= bucketSize * 2) weight = 2;
            
            // PV factor for year t is 1/(1+r)^t
            denominator += weight / Math.pow(1 + r, t);
        }
        return principal / denominator;
    }

    // --- é€€ä¼‘æ¨¡å¼é‚è¼¯ ---
    function calcRetire() {
        try {
            let assets = getNum('r-assets') * 10000;
            const buffer = getNum('r-buffer') * 10000;
            const ageNow = getNum('r-age-now');
            const ageEnd = getNum('r-age-end');
            const inflation = getNum('inflation');

            // è™•ç†å¢è²¸
            const loanEnabled = document.getElementById('r-loan-enabled').checked;
            let monthlyLoanPay = 0;
            let loanMsg = "";

            if (loanEnabled) {
                const loanAmt = getNum('r-loan-amt') * 10000;
                const loanRate = getNum('r-loan-rate');
                const loanYears = getNum('r-loan-years');

                // 1. å°‡å¢è²¸é‡‘é¡åŠ å…¥ç¾æœ‰è³‡ç”¢ (Inflow)
                assets += loanAmt;

                // 2. è¨ˆç®—æ¯æœˆæ‡‰é‚„æœ¬æ¯ (Outflow)
                if (loanAmt > 0 && loanYears > 0) {
                    monthlyLoanPay = PMT_Loan(loanRate, loanYears, loanAmt);
                }

                loanMsg = `
                    <strong>ğŸ  å·²å•Ÿç”¨æˆ¿å±‹å¢è²¸ï¼š</strong><br>
                    å¢è²¸é‡‘é¡ <strong>$${formatMoney(loanAmt/10000)}è¬</strong> å·²ä½µå…¥æœ¬é‡‘æ»¾åˆ©ã€‚<br>
                    æ¯æœˆéœ€ç¹³æˆ¿è²¸æœ¬æ¯ç´„ <strong>$${formatMoney(monthlyLoanPay)}</strong>ã€‚<br>
                    ä¸‹æ–¹è¨ˆç®—çµæœå·²è‡ªå‹•æ‰£é™¤æ­¤ç­†é‚„æ¬¾é‡‘é¡ã€‚
                `;
            }

            // å–å¾—å ±é…¬ç‡ (è‡ªè¨‚æˆ–ç°¡å–®)
            const rateNominal = getPortfolioRate('r', 'r-mode-val', 'r-rate', 'r-port');
            if (rateNominal === -1) {
                alert("é€€ä¼‘æ¨¡å¼ï¼šè‡ªè¨‚æŠ•è³‡çµ„åˆæ¯”ä¾‹ç¸½å’Œä¸ç‚º 100%ï¼Œè«‹ä¿®æ­£å¾Œå†è¨ˆç®—ã€‚");
                return;
            }

            if (ageEnd <= ageNow) return alert("ç™»å‡ºå¹´é½¡éœ€å¤§æ–¼ç›®å‰å¹´é½¡");
            
            const principal = assets - buffer;
            if (principal <= 0) return alert("è³‡ç”¢ä¸è¶³ä»¥ä¿ç•™é å‚™é‡‘ï¼Œè«‹èª¿æ•´é‡‘é¡");

            // Fisher Equation for Real Rate
            const realRate = ((1 + rateNominal/100) / (1 + inflation/100) - 1) * 100;
            const years = ageEnd - ageNow;

            // ä½¿ç”¨ä¿å®ˆç®—æ³• (Annual Logic)
            const baseUnitAnnual = calculateBaseUnit_Annual(principal, realRate, years);
            const flatAnnual = PMT_Annuity_Annual(principal, realRate, years);

            // è½‰æˆæœˆé¡¯ç¤º (ç›´æ¥é™¤ä»¥12)
            // å°‡ loanMsg å‚³å…¥ï¼Œä¸¦å‚³å…¥ monthlyLoanPay ä½œç‚ºæ‰£é™¤é …
            renderResults(ageNow, years/3, baseUnitAnnual/12, principal, "é€€ä¼‘æ¨¡å¼", 0, 0, loanMsg, [], [], flatAnnual, monthlyLoanPay);
        } catch (e) {
            alert("è¨ˆç®—ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ•¸å€¼");
            console.error(e);
        }
    }

    // --- å¹´è¼•äººæ¨¡å¼é‚è¼¯ ---
    function calcYoung() {
        try {
            const ageNow = getNum('y-age-now');
            const ageRetire = getNum('y-age-retire');
            const ageEnd = getNum('y-age-end');
            const currentAsset = getNum('y-current') * 10000;
            let monthlyInv = getNum('y-monthly');
            const inflation = getNum('inflation');
            
            // å–å¾— 1.ç´¯ç©æœŸå ±é…¬ç‡
            const rateAcc = getPortfolioRate('y', 'y-mode-val', 'y-rate-acc', 'y-port');
            if (rateAcc === -1) {
                alert("ç´¯ç©æœŸï¼šè‡ªè¨‚æŠ•è³‡çµ„åˆæ¯”ä¾‹ç¸½å’Œä¸ç‚º 100%ï¼Œè«‹ä¿®æ­£å¾Œå†è¨ˆç®—ã€‚");
                return;
            }
            const rAccDecimal = rateAcc / 100;

            if (ageRetire <= ageNow) return alert("é€€ä¼‘å¹´é½¡å¿…é ˆå¤§æ–¼ç›®å‰å¹´é½¡");
            if (ageEnd <= ageRetire) return alert("ç™»å‡ºå¹´é½¡å¿…é ˆå¤§æ–¼é€€ä¼‘å¹´é½¡");

            const houseEnabled = document.getElementById('house-enabled').checked;
            const houseAge = getNum('h-age');
            const housePrice = getNum('h-price') * 10000;
            const downPct = getNum('h-down-pct');
            const mortgageRate = getNum('h-rate');
            const mortgageYears = getNum('h-years');
            const originalRent = getNum('h-rent');

            let currentMoney = currentAsset;
            let chartData = [];
            let chartLabels = [];
            let houseMsg = "";
            let isBankrupt = false;
            let activeMortgagePayment = 0; // ç”¨ä¾†è¨˜éŒ„è¨ˆç®—å‡ºçš„æˆ¿è²¸æœˆä»˜é‡‘

            // ä¿å®ˆæ¼”ç®—æ³•ï¼šä»¥ã€Œå¹´ã€ç‚ºå–®ä½é€²è¡Œè¿´åœˆ
            const totalYearsAcc = ageRetire - ageNow;
            
            // åˆå§‹é»
            chartLabels.push(`${ageNow}æ­²`);
            chartData.push(Math.round(currentMoney));

            for (let i = 0; i < totalYearsAcc; i++) {
                let thisYearAge = ageNow + i;
                
                // 1. è™•ç†è²·æˆ¿ (å‡è¨­ç™¼ç”Ÿåœ¨è©²æ­²æ•¸çš„å¹´åˆ)
                if (houseEnabled && thisYearAge === houseAge) {
                    const downPayment = housePrice * (downPct / 100);
                    if (currentMoney < downPayment) {
                        alert(`è­¦å‘Šï¼šåœ¨ ${houseAge} æ­²æ™‚ï¼Œæ‚¨çš„è³‡ç”¢ç´¯ç©åƒ… ${formatMoney(currentMoney/10000)} è¬ï¼Œä¸è¶³ä»¥æ”¯ä»˜é ­æœŸæ¬¾ ${formatMoney(downPayment/10000)} è¬ã€‚`);
                        return; 
                    }
                    currentMoney -= downPayment;
                    const loanAmount = housePrice - downPayment;
                    const monthlyMortgage = PMT_Loan(mortgageRate, mortgageYears, loanAmount);
                    activeMortgagePayment = monthlyMortgage; // è¨˜éŒ„ä¸‹ä¾†ï¼Œä¾›é€€ä¼‘æœŸä½¿ç”¨

                    const extraCost = monthlyMortgage - originalRent; 
                    monthlyInv -= extraCost; 

                    houseMsg = `
                        <strong>ğŸ  è²·æˆ¿è¡æ“Šåˆ†æï¼š</strong><br>
                        æ‚¨åœ¨ ${houseAge} æ­²æ”¯ä»˜äº†é ­æœŸæ¬¾ <strong>$${formatMoney(downPayment/10000)}è¬</strong>ã€‚<br>
                        æ¯æœˆæˆ¿è²¸ç´„ <strong>$${formatMoney(monthlyMortgage)}</strong> (åŸæˆ¿ç§Ÿ $${formatMoney(originalRent)})ã€‚<br>
                        å°è‡´æ¯æœˆæŠ•è³‡é‡‘é¡è®Šç‚º <strong>$${formatMoney(monthlyInv)}</strong>ã€‚
                    `;
                }

                // 2. è³‡ç”¢æ»¾å‹• (ä¿å®ˆç®—æ³•ï¼šå¹´åˆæœ¬é‡‘æ»¾ä¸€å¹´ + è©²å¹´ç¸½æŠ•å…¥ä¸è¨ˆæ¯)
                // å¹´æŠ•å…¥ç¸½é¡
                let yearContribution = monthlyInv * 12;
                
                // æœ¬é‡‘æ»¾åˆ© (è‹¥æœ¬é‡‘å› è²·æˆ¿è®Šè² ï¼Œå‰‡ä¸è©²æ»¾åˆ©ï¼Œç”šè‡³è©²ç®—è² å‚µåˆ©æ¯ï¼Œä½†æ­¤è™•ç°¡åŒ–ç‚º0æˆ–è­¦å‘Š)
                if (currentMoney < 0) isBankrupt = true;

                currentMoney = currentMoney * (1 + rAccDecimal) + yearContribution;

                if (currentMoney < 0) isBankrupt = true;

                // è¨˜éŒ„å¹´åº•æ•¸æ“š (å³ä¸‹ä¸€å¹´æ­²æ•¸)
                chartLabels.push(`${thisYearAge + 1}æ­²`);
                chartData.push(Math.round(currentMoney));
            }

            if (isBankrupt) {
                alert("è­¦å‘Šï¼šè²·æˆ¿å¾Œçš„æˆ¿è²¸è² æ“”éé‡ï¼Œå°è‡´æ‚¨çš„æŠ•è³‡è³‡ç”¢åœ¨é€€ä¼‘å‰å·²è€—ç›¡ï¼");
                return;
            }

            const pension = getNum('y-pension') * 10000;
            let totalNominal = currentMoney + pension;
            
            // æŠ˜ç¾å›ä»Šæ—¥è³¼è²·åŠ›
            let totalReal = totalNominal / Math.pow(1 + inflation/100, totalYearsAcc);

            const bufferPct = getNum('y-buffer-pct');
            let playMoneyReal = totalReal * (1 - bufferPct/100);
            
            // å–å¾— 2.é€€ä¼‘å¾Œå ±é…¬ç‡ (New Logic: also supports portfolio)
            const rateDecNominal = getPortfolioRate('y-dec', 'y-dec-mode-val', 'y-rate-dec', 'y-dec-port');
            if (rateDecNominal === -1) {
                alert("é€€ä¼‘å¾Œï¼šè‡ªè¨‚æŠ•è³‡çµ„åˆæ¯”ä¾‹ç¸½å’Œä¸ç‚º 100%ï¼Œè«‹ä¿®æ­£å¾Œå†è¨ˆç®—ã€‚");
                return;
            }
            
            const realRateDec = ((1 + rateDecNominal/100) / (1 + inflation/100) - 1) * 100;
            const yearsDec = ageEnd - ageRetire;
            
            // æé ˜æœŸä¿å®ˆç®—æ³•
            const baseUnitAnnual = calculateBaseUnit_Annual(playMoneyReal, realRateDec, yearsDec);
            const flatAnnual = PMT_Annuity_Annual(playMoneyReal, realRateDec, yearsDec);

            // è¨ˆç®—é€€ä¼‘æ™‚æ˜¯å¦é‚„æœ‰æˆ¿è²¸è¦ç¹³ (Young Mode Logic)
            let deduction = 0;
            const mortgageEndAge = houseAge + mortgageYears;
            if (houseEnabled && mortgageEndAge > ageRetire) {
                // å¦‚æœé€€ä¼‘å¾Œæˆ¿è²¸é‚„æ²’ç¹³å®Œï¼Œè¨­å®šæ‰£é™¤é¡ (ç‚ºæ±‚ç°¡å–®æ¯”è¼ƒï¼Œæ­¤è™•å°‡é¡¯ç¤ºæ‰£é™¤æˆ¿è²¸å¾Œçš„æ·¨é¡)
                deduction = activeMortgagePayment;
            }

            // å°‡ deduction å‚³å…¥ renderResults
            renderResults(ageRetire, yearsDec/3, baseUnitAnnual/12, playMoneyReal, "å¹´è¼•äººæ¨¡å¼", totalNominal, totalReal, houseMsg, chartLabels, chartData, flatAnnual, deduction);

        } catch (e) {
            alert("è¨ˆç®—éç¨‹ç™¼ç”ŸéŒ¯èª¤");
            console.error(e);
        }
    }

    // --- Rendering ---
    let chartInstanceAcc = null;
    let chartInstanceDec = null;

    function renderResults(startAge, bucketSize, baseUnitMonthly, totalRealMoney, mode, nominalFV=0, realFV=0, houseMsg="", chartLabels=[], chartData=[], flatAnnual=0, monthlyFixedDeduction=0) {
        const area = document.getElementById('result-area');
        area.style.display = 'block';
        area.scrollIntoView({ behavior: 'smooth' });

        // Summary
        let html = '';
        if (mode === "é€€ä¼‘æ¨¡å¼") {
            html = `<h2 style="margin:0; color:#2c3e50">æ‚¨çš„äº«æ¨‚æœ¬é‡‘ (ç¾å€¼)ï¼š${formatMoney(totalRealMoney/10000)} è¬</h2>`;
        } else {
            html = `
                <h3 style="margin:5px 0; color:#7f8c8d">${startAge} æ­²ç´¯ç©è³‡ç”¢ï¼š${formatMoney(nominalFV/10000)} è¬</h3>
                <h2 style="margin:0; color:#27ae60">ä»Šæ—¥è³¼è²·åŠ›ï¼š${formatMoney(realFV/10000)} è¬</h2>
            `;
        }
        document.getElementById('result-summary').innerHTML = html;

        // House Message
        const msgDiv = document.getElementById('house-impact-msg');
        if (houseMsg) {
            msgDiv.style.display = 'block';
            msgDiv.innerHTML = houseMsg;
        } else {
            msgDiv.style.display = 'none';
        }

        // Deduction Note String
        const deductionNote = monthlyFixedDeduction > 0 ? "<div style='font-size:0.8em; color:#c0392b; margin-top:2px;'>(å·²æ‰£é™¤æˆ¿è²¸)</div>" : "";

        // Comparison Box
        const compBox = document.getElementById('comparison-block');
        compBox.style.display = 'flex';
        // å‚³çµ±å¹³æ»‘æ³•ä¹Ÿè¦æ‰£é™¤å›ºå®šé‚„æ¬¾
        let flatMonthly = (flatAnnual/12) - monthlyFixedDeduction;
        if (flatMonthly < 0) flatMonthly = 0;
        document.getElementById('flat-val').innerText = `$${formatMoney(flatMonthly)}`; 
        
        // Update comparison box note
        document.getElementById('comp-note-text').innerHTML = `æ¯æœˆå¯èŠ± (å¯¦è³ªè³¼è²·åŠ›)${deductionNote}`;

        // Header Visibility
        document.getElementById('dwz-section-title').style.display = 'flex';

        // Phase Cards
        // é€™è£¡éœ€è¦æ‰£é™¤ monthlyFixedDeduction
        let m1 = (baseUnitMonthly * 3) - monthlyFixedDeduction;
        let m2 = (baseUnitMonthly * 2) - monthlyFixedDeduction;
        let m3 = (baseUnitMonthly * 1) - monthlyFixedDeduction;
        
        // é¿å…é¡¯ç¤ºè² æ•¸
        if (m1 < 0) m1 = 0;
        if (m2 < 0) m2 = 0;
        if (m3 < 0) m3 = 0;

        const p1End = Math.floor(startAge + bucketSize);
        const p2End = Math.floor(startAge + bucketSize * 2);
        const p3End = Math.floor(startAge + bucketSize * 3);

        document.getElementById('phase-container').innerHTML = `
            <div class="phase-card p-gold">
                <div class="p-title">ğŸš€ é»ƒé‡‘æœŸ (${startAge} - ${p1End}æ­²)</div>
                <div class="p-amt">$${formatMoney(m1)}</div>
                <div class="p-desc">æ¯æœˆå¯èŠ±${deductionNote}</div>
            </div>
            <div class="phase-card p-silver">
                <div class="p-title">ğŸš¢ ç™½éŠ€æœŸ (${p1End} - ${p2End}æ­²)</div>
                <div class="p-amt">$${formatMoney(m2)}</div>
                <div class="p-desc">æ¯æœˆå¯èŠ±${deductionNote}</div>
            </div>
            <div class="phase-card p-bronze">
                <div class="p-title">ğŸ¡ æ…¢æ´»æœŸ (${p2End} - ${p3End}æ­²)</div>
                <div class="p-amt">$${formatMoney(m3)}</div>
                <div class="p-desc">æ¯æœˆå¯èŠ±${deductionNote}</div>
            </div>
        `;

        // Chart Rendering Logic
        const accContainer = document.getElementById('acc-chart-container');
        
        // Always draw Decumulation Chart (Bottom)
        drawDecChart(startAge, bucketSize * 3, bucketSize, baseUnitMonthly, flatAnnual/12, monthlyFixedDeduction);

        // If Young Mode, also draw Accumulation Chart (Top)
        if (mode === "å¹´è¼•äººæ¨¡å¼" && chartData.length > 0) {
            accContainer.style.display = 'block';
            drawAccChart(chartLabels, chartData);
        } else {
            accContainer.style.display = 'none';
        }
    }

    function drawAccChart(labels, data) {
        const ctx = document.getElementById('chartAcc').getContext('2d');
        if (chartInstanceAcc) chartInstanceAcc.destroy();
        
        chartInstanceAcc = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'è³‡ç”¢ç´¯ç© (åç›®é‡‘é¡, ä¿å®ˆä¼°ç®—)',
                    data: data,
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: false, title: { display: true, text: 'ç¸½è³‡ç”¢ (å…ƒ)' } }
                }
            }
        });
    }

    function drawDecChart(startAge, totalYears, bucketSize, baseUnitMonthly, flatMonthly, deduction) {
        const ctx = document.getElementById('chartDec').getContext('2d');
        if (chartInstanceDec) chartInstanceDec.destroy();

        let labels = [];
        let data = [];
        let dataFlat = [];
        let backgroundColors = [];

        // å‚³çµ±å¹³æ»‘æ³•æ‰£é™¤è²¸æ¬¾
        let adjustedFlat = flatMonthly - deduction;
        if (adjustedFlat < 0) adjustedFlat = 0;

        for (let i = 0; i < totalYears; i++) {
            labels.push(`${startAge + i}æ­²`);
            
            let val = 0;
            let color = '';
            if (i < bucketSize) {
                val = (baseUnitMonthly * 3) - deduction;
                color = 'rgba(241, 196, 15, 0.7)'; 
            } else if (i < bucketSize * 2) {
                val = (baseUnitMonthly * 2) - deduction;
                color = 'rgba(189, 195, 199, 0.7)'; 
            } else {
                val = (baseUnitMonthly * 1) - deduction;
                color = 'rgba(144, 224, 239, 0.7)'; 
            }
            if (val < 0) val = 0;

            data.push(val);
            dataFlat.push(adjustedFlat);
            backgroundColors.push(color);
        }

        chartInstanceDec = new Chart(ctx, {
            data: {
                labels: labels,
                datasets: [
                    {
                        type: 'line',
                        label: 'å‚³çµ±å¹³æ»‘æé ˜ (å›ºå®š)',
                        data: dataFlat,
                        borderColor: '#95a5a6',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false,
                        order: 0
                    },
                    {
                        type: 'bar',
                        label: 'Die With Zero å»ºè­° (éšæ¢¯)',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 0,
                        borderRadius: 4,
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'æœˆé ç®— (å¯¦è³ªè³¼è²·åŠ›)' } }
                }
            }
        });
    }
</script>

</body>
</html>
